# Load profile into current session

.zem_load() {
    emulate -L zsh
    setopt extended_glob warn_create_global typeset_silent

    local MATCH REPLY
    integer MBEGIN MEND
    local -a match mbegin mend reply

    local profile=$1
    local set_default=0
    local profile_dir="${XDG_CONFIG_HOME:-$HOME/.config}/zem/profiles"

    # Parse --default flag
    if [[ $2 == "--default" ]]; then
        set_default=1
    fi

    local profile_file="$profile_dir/$profile"

    # Validate arguments
    if [[ -z $profile ]]; then
        echo "‚ùå Missing profile name."
        echo "Usage: zem load <profile> [--default]"
        return 1
    fi

    # Validate profile name
    .zem_validate_profile_name "$profile" || return 1

    # Check if profile exists
    if [[ ! -f $profile_file ]]; then
        echo "‚ùå Profile '$profile' does not exist."
        echo "Run 'zem list' to see available profiles."
        return 1
    fi

    # Set as default if requested
    if (( set_default )); then
        .zem_config_set default_profile "$profile" || {
            echo "‚ùå Failed to save default profile."
            return 1
        }
        echo "‚úÖ Set '$profile' as default profile."
    fi

    # Optional: Confirm before loading (controlled by ZEM_CONFIRM_LOAD)
    if [[ -n $ZEM_CONFIRM_LOAD ]]; then
        echo "‚ö†Ô∏è  Warning: This will execute code from '$profile'"
        echo "   File: $profile_file"
        read "?Continue? [y/N] " response
        if [[ ! $response =~ ^[yY]$ ]]; then
            echo "Cancelled."
            return 0
        fi
    fi

    # Source the profile
    source "$profile_file" || {
        echo "‚ùå Failed to load profile: $profile"
        return 1
    }

    echo "üöÄ Profile '$profile' loaded successfully!"
    return 0
}
